{"changed":true,"filter":false,"title":"cities.js","tooltip":"/routes/cities.js","value":"var express = require('express');\n\nvar router = express.Router();\n\n\n/* Get All Cities */\nrouter.get('/', function(req, res) {\n    var db = req.db;\n    var collection = db.get('city');\n    collection.find({},{},function(e,city1){\n    \t  res.writeHead(200, {'Content-Type': 'application/json'}); // Sending data via json\n\t\t  var str='[';\n\t\t  city1.forEach(function(city) {\n\t\t\t  str = str + '{ \"city\" : \"' + city.city + '\"},' +'\\n';\n\t\t  });\n\t\t  str = str.trim();\n\t\t  str = str.substring(0,str.length-1);\n\t\t  str = str + ']';\t\n\t\t  res.end(str);\n    });\n});\n\n\n/*\n{ \"_id\" : ObjectId(\"54d7db0e89dc3223d90002bf\"), \"city_id\" : 100, \"city\" : \"Cam R\nanh\", \"country_id\" : 105, \"last_update\" : ISODate(\"2006-02-15T09:45:25Z\") }\n>\n*/\n\nrouter.put('/:id', function(req, res) {\n    var db = req.db;\n    var collection = db.get('city');\n    //console.log(\"Inside put\");\n\n    if(!req.body) { \n        return res.send(400); \n    } // 6\n\n    var id = req.params.id;\n    console.log(id);\n    \n    if (!Number(id)) {\n    \treturn res.send(\"Invalid query parameters\");\n    }\n    \t\n    //console.log('Helllo Worlld...!!!');\n    //console.log(req.body.param2);\n    \n\n    //Get the other params from the query. Should get a list of query parameters that we will take\n    //city, country_id, last_update(auto generated)\n    collection.find({city_id: Number(id)}, {},  function(e,data){  \n        if(e) { \n            return res.send(500, e); \n        } // 1, 2\n\n        console.log(\"result of findbyid, before data check \", data);\n        if(!data) { \n        \tconsole.log(\"Inside !data\");\n            return res.send(404); \n        } // 3\n        \n        \n        //console.log(\"Before update\");\n        var update = {};\n        if (req.body.city != undefined)\n            update['city'] = req.body.city;\n        update['last_update'] = new Date().toISOString();\n        if (req.body.country_id != undefined)\n        {\n            //Continue updating only if the city id mentioned is valid in 'city' collection \n            var countryColl = db.get('country');\n            countryColl.count({\n            \t\tcountry_id: Number(req.body.country_id)\n            \t}, function (err, count) {\n\t\t\t\t\t\tif(err || count === 0) {\n\t\t\t\t\t\t\treturn res.send(404, err);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconsole.log(\"Found the object: \",count);\n\t\t\t\t\t\tupdate['country_id'] = req.body.country_id;\n\t\t\t\t\t\tUpdateDB(collection, update, res, id);\n\t\t\t\t\t\tres.send(\"Update succeeded\");\n            });\n        }\n        else //In case city_id not found, update other values\n        {\n            UpdateDB(collection, update, res, id);\n            res.send(\"Update succeeded\");\n        }\n    });\n});    \n        \nfunction UpdateDB(collection, update, res, id)\n{\n    console.log(update);\n\n    collection.update(\n        { city_id: Number(id) },\n        { $set: update },\n        function(err) {\n            if (err) {\n                return res.send(500, err);\n            }\n\n            // Now we can get the order back\n            // and see that it's updated\n            collection.find({\n                city_id: Number(id)\n            }, function(err, o) {\n                if (err) {\n                    return res.send(500, err);\n                }\n                console.log(\"Found the object: \", o);\n            });\n        });\n\n        return;\n}\n\n//Delete one city\nrouter.delete('/:CityId', function(req, res){\n    var db = req.db;\n    var collection = db.get('city');\n    var id = parseInt(req.params.CityId);\n    collection.remove({\n        city_id : id\n    }, function(err, todo){\n        if(err){\n            res.end(err);\n        }\n        else\n        \tres.end(\"deleted\");\n    });\n});\n\nmodule.exports = router;","undoManager":{"mark":94,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":69,"column":23},"end":{"row":69,"column":24},"action":"insert","lines":["y"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":38},"end":{"row":69,"column":39},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":38},"end":{"row":69,"column":39},"action":"remove","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":38},"end":{"row":69,"column":39},"action":"remove","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":38},"end":{"row":69,"column":39},"action":"remove","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":38},"end":{"row":69,"column":39},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":38},"end":{"row":69,"column":39},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":38},"end":{"row":69,"column":39},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":38},"end":{"row":69,"column":39},"action":"remove","lines":["L"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":38},"end":{"row":69,"column":39},"action":"remove","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":38},"end":{"row":69,"column":39},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":38},"end":{"row":69,"column":39},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":38},"end":{"row":69,"column":39},"action":"remove","lines":["1"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":38},"end":{"row":69,"column":39},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":39},"end":{"row":69,"column":40},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":40},"end":{"row":69,"column":41},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":41},"end":{"row":69,"column":42},"action":"insert","lines":["y"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":2,"column":3},"action":"remove","lines":["/**"," * New node file"," */"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":1,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":79,"column":16},"end":{"row":79,"column":27},"action":"remove","lines":["End of file"]},{"start":{"row":79,"column":16},"end":{"row":79,"column":32},"action":"insert","lines":["Update succeeded"]}]}],[{"group":"doc","deltas":[{"start":{"row":85,"column":22},"end":{"row":85,"column":33},"action":"remove","lines":["End of file"]},{"start":{"row":85,"column":22},"end":{"row":85,"column":38},"action":"insert","lines":["Update succeeded"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":27},"end":{"row":72,"column":28},"action":"remove","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":26},"end":{"row":72,"column":27},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":25},"end":{"row":72,"column":26},"action":"remove","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":24},"end":{"row":72,"column":25},"action":"remove","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":24},"end":{"row":72,"column":25},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":25},"end":{"row":72,"column":26},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":26},"end":{"row":72,"column":27},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":27},"end":{"row":72,"column":28},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":28},"end":{"row":72,"column":29},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":12},"end":{"row":73,"column":13},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":13},"end":{"row":73,"column":14},"action":"insert","lines":["|"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":14},"end":{"row":73,"column":15},"action":"insert","lines":["|"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":15},"end":{"row":73,"column":16},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":16},"end":{"row":73,"column":17},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":17},"end":{"row":73,"column":18},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":18},"end":{"row":73,"column":19},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":19},"end":{"row":73,"column":20},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":20},"end":{"row":73,"column":21},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":21},"end":{"row":73,"column":22},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":22},"end":{"row":73,"column":23},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":23},"end":{"row":73,"column":24},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":24},"end":{"row":73,"column":25},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":25},"end":{"row":73,"column":26},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":26},"end":{"row":73,"column":27},"action":"insert","lines":["0"]}]}],[{"group":"doc","deltas":[{"start":{"row":76,"column":39},"end":{"row":76,"column":40},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":76,"column":39},"end":{"row":76,"column":40},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":76,"column":40},"end":{"row":76,"column":41},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":76,"column":41},"end":{"row":76,"column":42},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":76,"column":42},"end":{"row":76,"column":43},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":76,"column":43},"end":{"row":76,"column":44},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":88},"end":{"row":72,"column":89},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":88},"end":{"row":72,"column":89},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":89},"end":{"row":72,"column":90},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":90},"end":{"row":72,"column":91},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":91},"end":{"row":72,"column":92},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":92},"end":{"row":72,"column":93},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":31},"end":{"row":73,"column":0},"action":"insert","lines":["",""]},{"start":{"row":73,"column":0},"end":{"row":73,"column":13},"action":"insert","lines":["            \t"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":13},"end":{"row":73,"column":14},"action":"insert","lines":["\t"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":14},"end":{"row":73,"column":15},"action":"insert","lines":["\t"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":54},"end":{"row":75,"column":12},"action":"insert","lines":["","            \t","            "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":12},"end":{"row":74,"column":13},"action":"remove","lines":["\t"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":11},"end":{"row":74,"column":12},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":10},"end":{"row":74,"column":11},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":9},"end":{"row":74,"column":10},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":8},"end":{"row":74,"column":9},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":7},"end":{"row":74,"column":8},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":6},"end":{"row":74,"column":7},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":5},"end":{"row":74,"column":6},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":4},"end":{"row":74,"column":5},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":3},"end":{"row":74,"column":4},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":2},"end":{"row":74,"column":3},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":1},"end":{"row":74,"column":2},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":0},"end":{"row":74,"column":1},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":54},"end":{"row":74,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":13},"end":{"row":73,"column":14},"action":"remove","lines":["\t"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":13},"end":{"row":73,"column":14},"action":"remove","lines":["\t"]}]}],[{"group":"doc","deltas":[{"start":{"row":74,"column":12},"end":{"row":74,"column":13},"action":"insert","lines":["\t"]}]}],[{"group":"doc","deltas":[{"start":{"row":73,"column":13},"end":{"row":73,"column":14},"action":"insert","lines":["\t"]}]}],[{"group":"doc","deltas":[{"start":{"row":90,"column":7},"end":{"row":90,"column":11},"action":"remove","lines":["    "]},{"start":{"row":90,"column":7},"end":{"row":91,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":91,"column":0},"end":{"row":92,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":91,"column":0},"end":{"row":92,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":90,"column":7},"end":{"row":91,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":118,"column":0},"end":{"row":119,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":119,"column":0},"end":{"row":136,"column":3},"action":"insert","lines":["//Delete one city","router.delete('/:CityId', function(req, res){","    var db = req.db;","    var collection = db.get('city');","    var id = parseInt(req.params.CityId);","    ","    collection.find({},{},function(e,data){ ","        collection.remove({","            city_id : id","        }, function(err, todo){","            if(err){","                res.end(err);","            }","            else","            \tres.end(\"deleted\");","        });","    });","});"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":3},"end":{"row":125,"column":44},"action":"remove","lines":[" collection.find({},{},function(e,data){ "]}]}],[{"group":"doc","deltas":[{"start":{"row":135,"column":6},"end":{"row":135,"column":7},"action":"remove","lines":[";"]}]}],[{"group":"doc","deltas":[{"start":{"row":135,"column":5},"end":{"row":135,"column":6},"action":"remove","lines":[")"]}]}],[{"group":"doc","deltas":[{"start":{"row":135,"column":4},"end":{"row":135,"column":5},"action":"remove","lines":["}"]}]}],[{"group":"doc","deltas":[{"start":{"row":134,"column":11},"end":{"row":135,"column":0},"action":"insert","lines":["",""]},{"start":{"row":135,"column":0},"end":{"row":135,"column":8},"action":"insert","lines":["        "]}]}],[{"group":"doc","deltas":[{"start":{"row":126,"column":0},"end":{"row":126,"column":4},"action":"remove","lines":["    "]},{"start":{"row":127,"column":0},"end":{"row":127,"column":4},"action":"remove","lines":["    "]},{"start":{"row":128,"column":0},"end":{"row":128,"column":4},"action":"remove","lines":["    "]},{"start":{"row":129,"column":0},"end":{"row":129,"column":4},"action":"remove","lines":["    "]},{"start":{"row":130,"column":0},"end":{"row":130,"column":4},"action":"remove","lines":["    "]},{"start":{"row":131,"column":0},"end":{"row":131,"column":4},"action":"remove","lines":["    "]},{"start":{"row":132,"column":0},"end":{"row":132,"column":4},"action":"remove","lines":["    "]},{"start":{"row":133,"column":0},"end":{"row":133,"column":4},"action":"remove","lines":["    "]},{"start":{"row":134,"column":0},"end":{"row":134,"column":4},"action":"remove","lines":["    "]},{"start":{"row":135,"column":0},"end":{"row":135,"column":4},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":124,"column":4},"end":{"row":126,"column":4},"action":"remove","lines":["","   ","    "]}]}],[{"group":"doc","deltas":[{"start":{"row":134,"column":0},"end":{"row":134,"column":1},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":133,"column":4},"end":{"row":134,"column":3},"action":"remove","lines":["","   "]}]}],[{"group":"doc","deltas":[{"start":{"row":132,"column":7},"end":{"row":133,"column":4},"action":"remove","lines":["","    "]}]}],[{"group":"doc","deltas":[{"start":{"row":135,"column":24},"end":{"row":136,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":136,"column":0},"end":{"row":137,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":0},"end":{"row":137,"column":38},"action":"insert","lines":["https://github.com/pbs2124/MISOAD1.git"]}]}],[{"group":"doc","deltas":[{"start":{"row":137,"column":0},"end":{"row":137,"column":38},"action":"remove","lines":["https://github.com/pbs2124/MISOAD1.git"]}]}],[{"group":"doc","deltas":[{"start":{"row":136,"column":0},"end":{"row":137,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":135,"column":24},"end":{"row":136,"column":0},"action":"remove","lines":["",""]}]}]]},"ace":{"folds":[],"scrolltop":1861.5,"scrollleft":0,"selection":{"start":{"row":135,"column":24},"end":{"row":135,"column":24},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":115,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1423779674212}